<!-- h1>Your Cart</h1 -->

<% total = 0 %>

<% if @cart.empty? %>

  <br><br><br>
  <a href="<%= products_path %>">
    <div class="tile">
        <br><br>
        <h2 class="text_center">Your cart is currently empty.</h2>
        <br><br>
        <h1 class="text_center">Buy something!</h1>
        <div><%= image_tag("buy_something_basket.png", class: "image_size") %></div>
    </div>
  </a>

<% else %>

  <h2 class="apart"><%= link_to "Empty your Cart", cart_clear_path %></h2>
  <br><br><br><br>

  <% @cart.each do |id, quantity| %>

    <% product = Product.find_by_id(id) %>

    <% if quantity == 0 %>

      <%# To delete the tile of the item from the cart: %>
      <% id = nil %>

    <% else %>

        <div class="tile">
          <div><%= image_tag product.image_url, class: "image_size" %></div>
          <h3 class="text_bckg"><%= product.title %></h3>
          <p class="text_bckg"><b class="text_bckg">Unit Price: </b><%= number_to_currency(product.price, :unit => "$") %></p>
          <p class="text_bckg"><b class="text_bckg">Quantity: </b><%= quantity %></p>
          <p class="text_bckg"><b class="text_bckg">Sub-Total: </b>$<%= quantity * product.price %></p>
          <p class="tile-left-span"><a href="/cart/less/<%= product.id %>" class="button">-1</a>
          <p class="tile-right-span"><a href="/cart/more/<%= product.id %>" class="button">+1</a>
        </div>

    <% end %>

  <% total += quantity * product.price %>

  <% end %>

  <% if total >= 1 %>

    <%# This tile appeara only once, no matter how many items there are in the cart. %>
    <a href="<%= products_path %>">
      <div class="tile">
        <br><br>
        <h2 class="text_center">Add other items to your cart</h2>
        <br><br>
        <!-- h1 class="text_center">Buy something!</h1 -->
        <div><%= image_tag("buy_something_basket.png", class: "image_size") %></div>
      </div>
    </a>

  <% else %>

    <% clearCart %>

    <%# Another way to do this, without creating a helper method in the cart controller: %>
    <%# controller.redirect_to cart_clear_path %>

  <% end %>

  <h2 class="apart">
    <strong>Your cart's total:</strong>
    <b><%= number_to_currency(total, :unit => "$") %></b>
  </h2>

  <h1 class="apart"><%= link_to "Continue Shopping", products_path %></h1>

  <!-- h3 class="apart">E-xact's Payment Page Demo - This is supposed to be normal HCO, without Silent Post</h3 -->
  <%= form_tag("https://rpm.demo.e-xact.com/payment", method: "post") do %>
  <%#= form_tag("https://rpm.demo.e-xact.com/payment"(@user.id, @relay), method: "post") do %>

    <%# The payment data %>
    <% x_login = Rails.application.secrets.ex_hco_b1_nsp_id %>
    <%# x_fp_sequence = "1234567890" %>
    <% x_fp_sequence = ((rand*100000).to_i + 5000).to_s %>
    <% x_fp_timestamp = Time.now.to_i.to_s %>
    <% x_tax = (total * 0.0).round(2) %>
    <% x_freight = 0.00 %>
    <% x_amount = total + x_tax + x_freight %>
    <% x_currency_code = "CAD" %>
    <% transaction_key = Rails.application.secrets.ex_hco_b1_nsp_tk %>
    <%# If preauth is required (however, preauth can't be completed through HCO): %>
    <% x_type = "AUTH_CAPTURE" %>

    <%# Order and Customer Detail Fields %>
    <% x_invoice_num = ((rand*10000).to_i).to_s %>
    <% x_po_num = "P.O." + (((rand*10000).to_i).to_s) %>

    <%# Format for the x_line_item. This will be generate with an each/do below  %>
    <%# x_line_item = "Item ID<|>Item Name<|>Item Description<|>Item Quantity<|>Item Price<|>Item Taxable(YES/NO)<|>" %>
    <%# x_line_item_1 = "<|><|>1999 Cabernet Sauvignon, 0.7 l <|>10<|>19.95<|>YES" %>
    <%# x_line_item_2 = "<|><|>2003 Merlot, 0.7 l<|>12<|>23.95<|>YES" %>

    <%# Customer Name and Billing Address Fields %>
    <% x_first_name = current_user.first_name %>
    <% x_last_name = current_user.last_name %>
    <% x_email = current_user.email %>
    <% x_company = current_user.company %>
    <% x_address = current_user.address %>
    <% x_city = current_user.city %>
    <% x_state = current_user.state %>
    <% x_zip = current_user.postal_code %>
    <% x_country = current_user.country %>
    <% x_phone = current_user.cell_phone %>
    <% x_fax = current_user.fax %>

    <%# Customer Shipping Address Fields %>
    <%# x_ship_to_first_name = current_user.username %>
    <%# x_ship_to_last_name = current_user.username %>
    <%# x_ship_to_company = current_user.username %>
    <%# x_ship_to_address = current_user.username %>
    <%# x_ship_to_city = current_user.username %>
    <%# x_ship_to_state = current_user.username %>
    <%# x_ship_to_zip = current_user.username %>
    <%# x_ship_to_country = current_user.username %>

    <%# Concatenating the values included in the x_fp_hash  %>
    <% hmac_string = "#{x_login}^#{x_fp_sequence}^#{x_fp_timestamp}^#{x_amount}^#{x_currency_code}" %>

    <%# Calculating HMAC-MD5 %>
    <% x_fp_hash = OpenSSL::HMAC.hexdigest(OpenSSL::Digest::Digest.new("md5"),transaction_key, hmac_string) %>

    <%# relay = 10 %>
    <%#= hidden_field_tag 'relay', relay %>

    <%= hidden_field_tag 'x_type', x_type %>
    <%= hidden_field_tag 'x_amount', x_amount %>
    <%#= hidden_field_tag 'x_card_num', x_card_num %>
    <%= hidden_field_tag 'x_login', x_login %>
    <%= hidden_field_tag 'x_fp_sequence', x_fp_sequence %>
    <%= hidden_field_tag :x_fp_timestamp, x_fp_timestamp %>
    <%= hidden_field_tag :x_currency_code, x_currency_code %>
    <%= hidden_field_tag :x_fp_hash, x_fp_hash %>
    <%= hidden_field_tag :x_show_form, "PAYMENT_FORM" %>
    <%= hidden_field_tag :x_invoice_num, x_invoice_num %>
    <%= hidden_field_tag :x_po_num, x_po_num %>

    <%# Generation of the x_line_item hidden_field_tag %>
    <%#= hidden_field_tag :x_line_item, x_line_item_1 %>
    <% @cart.each do |id, quantity| %>
      <% product = Product.find_by_id(id) %>
        <%= hidden_field_tag :x_line_item, "<|><|>#{product.title}<|>#{quantity}<|>#{product.price}<|>YES" %></p>
    <% end %>

    <%= hidden_field_tag :x_tax, x_tax %>
    <%= hidden_field_tag :x_freight, x_freight %>
    <%= hidden_field_tag :x_first_name, x_first_name %>
    <%= hidden_field_tag :x_last_name, x_last_name %>
    <%= hidden_field_tag :x_email, x_email %>
    <%# = hidden_field_tag :x_ship_to_first_name, x_ship_to_first_name %>
    <%# = hidden_field_tag :x_ship_to_last_name, x_ship_to_last_name %>

    <p class="apart">
      <a><%= submit_tag "Checkout with EÂ­-xact's HCO - Normal Receipt Page", class: 'button' %></a>
    </p>

  <% end %>

  <!-- h3 class="apart">PayEezy's Payment Page Demo</h3 -->
  <% if current_user.admin? %>

    <%= form_tag("https://demo.globalgatewaye4.firstdata.com/payment", method: "post") do %>
    <%#= form_tag("https://checkout.globalgatewaye4.firstdata.com/payment", method: "post") do %>

      <%# The payment data %>
      <% x_login = "HCO-R0V1-817" %>
      <%# x_fp_sequence = "1234567890" %>
      <% x_fp_sequence = ((rand*100000).to_i + 5000).to_s %>
      <% x_fp_timestamp = Time.now.to_i.to_s %>
      <% x_tax = (total * 0.0).round(2) %>
      <% x_freight = 0.00 %>
      <% x_amount = total + x_tax + x_freight %>
      <% x_currency_code = "USD" %>
      <% transaction_key = "~gYj39jq0zeGd2~nuaDB" %>
      <%# If preauth is required (however, preauth can't be completed through HCO): %>
      <% x_type = "AUTH_CAPTURE" %>

      <%# Order and Customer Detail Fields %>
      <% x_invoice_num = "123456" %>
      <% x_po_num = "PO123456" %>
      <%# x_line_item = "Item ID<|>Item Name<|>Item Description<|>Item Quantity<|>Item Price<|>Item Taxable(YES/NO)<|>" %>
      <% x_line_item = "2<|>Item Name 2<|>Item Description 2<|>1<|>2.00<|>YES<|>" %>
      <% x_line_item = "1<|>Item Name 1<|>Item Description 1<|>1<|>1.00<|>YES<|>" %>


      <%# Customer Name and Billing Address Fields %>
      <% x_first_name = current_user.first_name %>
      <% x_last_name = current_user.last_name %>
      <% x_email = current_user.email %>
      <% x_company = current_user.company %>
      <% x_address = current_user.address %>
      <% x_city = current_user.city %>
      <% x_state = current_user.state %>
      <% x_zip = current_user.postal_code %>
      <% x_country = current_user.country %>
      <% x_phone = current_user.cell_phone %>
      <% x_fax = current_user.fax %>

      <%# Customer Shipping Address Fields %>
      <%# x_ship_to_first_name = current_user.username %>
      <%# x_ship_to_last_name = current_user.username %>
      <%# x_ship_to_company = current_user.username %>
      <%# x_ship_to_address = current_user.username %>
      <%# x_ship_to_city = current_user.username %>
      <%# x_ship_to_state = current_user.username %>
      <%# x_ship_to_zip = current_user.username %>
      <%# x_ship_to_country = current_user.username %>

      <%# Concatenating the values included in the x_fp_hash  %>
      <% hmac_string = "#{x_login}^#{x_fp_sequence}^#{x_fp_timestamp}^#{x_amount}^#{x_currency_code}" %>

      <%# Calculating HMAC-MD5 %>
      <% x_fp_hash = OpenSSL::HMAC.hexdigest(OpenSSL::Digest::Digest.new("md5"),transaction_key, hmac_string) %>

      <%# relay = 10 %>
      <%#= hidden_field_tag 'relay', relay %>

      <%= hidden_field_tag 'x_type', x_type %>
      <%= hidden_field_tag 'x_amount', x_amount %>
      <%#= hidden_field_tag 'x_card_num', x_card_num %>
      <%= hidden_field_tag 'x_login', x_login %>
      <%= hidden_field_tag 'x_fp_sequence', x_fp_sequence %>
      <%= hidden_field_tag :x_fp_timestamp, x_fp_timestamp %>
      <%= hidden_field_tag :x_currency_code, x_currency_code %>
      <%= hidden_field_tag :x_fp_hash, x_fp_hash %>
      <%= hidden_field_tag :x_show_form, "PAYMENT_FORM" %>
      <%= hidden_field_tag :x_invoice_num, x_invoice_num %>
      <%= hidden_field_tag :x_po_num, x_po_num %>

      <%# Generation of the x_line_item hidden_field_tag %>
      <%#= hidden_field_tag :x_line_item, x_line_item_1 %>
      <% @cart.each do |id, quantity| %>
        <% product = Product.find_by_id(id) %>
          <%= hidden_field_tag :x_line_item, "<|><|>#{product.title}<|>#{quantity}<|>#{product.price}<|>YES" %></p>
      <% end %>

      <%= hidden_field_tag :x_tax, x_tax %>
      <%= hidden_field_tag :x_freight, x_freight %>
      <%= hidden_field_tag :x_first_name, x_first_name %>
      <%= hidden_field_tag :x_last_name, x_last_name %>
      <%= hidden_field_tag :x_email, x_email %>
      <%# = hidden_field_tag :x_ship_to_first_name, x_ship_to_first_name %>
      <%# = hidden_field_tag :x_ship_to_last_name, x_ship_to_last_name %>

      <%# Testing the x_tpp_id field %>
      <% x_tpp_id = "ECV001" %>
      <%= hidden_field_tag :x_tpp_id, x_tpp_id %>
      <% x_whatever_id = "ECV001" %>
      <%= hidden_field_tag :x_whatever_id, x_whatever_id %>

      <p class="apart">
        <a><%= submit_tag "Confirm and Checkout with PayEezy", class: 'button' %></a>
      </p>
    <% end %>
  <% end %>

  <h3 class="apart">You can get a test credit card number <a href="https://hostedcheckout.zendesk.com/entries/231255-Using-test-credit-card-numbers" target="_blank">here</a>.<h3>

<% end %>
